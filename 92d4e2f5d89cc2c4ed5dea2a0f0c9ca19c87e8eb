{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "da1515ea_73e39280",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-29T15:00:50Z",
      "side": 1,
      "message": "I am confused by some of the changes. Is this supposed to properly fix the issues, or is this meant as band-aid until someone finds time to fix it for real?",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "57355bad_b768ea40",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-03-30T23:21:58Z",
      "side": 1,
      "message": "I understand your confusion. Let me give a short introduction about this CL and my motives and goals for it.\n\nI\u0027m working on NodeJS supporting Windows. In Node, we periodically update the V8 engine. When updating to V8 11.2, we noticed issues with cross-compilation from x64 to arm64 (Node uses MSVC). I started investigating that and found the issues I am addressing in this CL.\n\nGiven that this is my first contact with the V8 source code, my knowledge of it is extremely low. That\u0027s why I aimed to mostly add changes that would not affect anything that\u0027s already working (thus wrapping all my changes in \"#ifdef V8_MSVC_X64_TO_ARM64\"). Also, my main focus is enabling V8 compilation as a part of Node.\n\nSo, to answer you in short, this is meant as a band-aid mainly because of my lack of knowledge about V8, but if you and/or other reviewers can offer some guidance I\u0027d be open to working on this and making it a real fix.",
      "parentUuid": "da1515ea_73e39280",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3c819c0e_e463a602",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-31T11:30:47Z",
      "side": 1,
      "message": "Thanks for the context. There is not reason to try to not change any existing code. Instead of all the `#ifdef`s, the code would be a lot more maintainable long-term if we find a way to rewrite it such that it works on all compilers and platforms.\n\nAs this CL does several things at once, you could also try splitting it into multiple CLs which might make reviewing and iterating on it easier.",
      "parentUuid": "57355bad_b768ea40",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "61cfaa37_d8ed4bae",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000264
      },
      "writtenOn": "2023-03-31T19:27:34Z",
      "side": 1,
      "message": "\u003e I\u0027m working on NodeJS supporting Windows. In Node, we periodically update the V8 engine. When updating to V8 11.2, we noticed issues with cross-compilation from x64 to arm64 (Node uses MSVC).\n\nOne question, bearing in mind that I\u0027m not on the V8 team (I\u0027m just an owner for a small part of V8, src/trap-handler/):\n\nHave you considered using Clang instead of MSVC, at least for ARM64?  You could potentially use Clang just for V8 since it\u0027s meant to be ABI-compatible (and I assume that\u0027s true for ARM64 too).  I realise that build systems might make that difficult.  I don\u0027t think V8 tests against MSVC, so you might find it an uphill battle to use MSVC.  There were some recent changes for making V8 cross-compile successfully for ARM64 Windows with MSVC, but it\u0027s very easy for that to regress.",
      "parentUuid": "3c819c0e_e463a602",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "e382746b_6c64b25d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-04-05T13:06:17Z",
      "side": 1,
      "message": "@clemensb@chromium.org I\u0027ve opened [another CL](https://chromium-review.googlesource.com/c/v8/v8/+/4403215) for landing one part of these changes with your comments addressed. Another CL can be used for the ProbeMemory part afterwards.\n\n\u003e You could potentially use Clang just for V8 since it\u0027s meant to be ABI-compatible (and I assume that\u0027s true for ARM64 too)\n\nThere is [this PR in the NodeJS repo](https://github.com/nodejs/node/pull/35433) that does something like that, but it\u0027s been stale for some time.",
      "parentUuid": "61cfaa37_d8ed4bae",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "09a91a0c_87e8ecdf",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-05-09T10:15:24Z",
      "side": 1,
      "message": "@clemensb@chromium.org I\u0027ve opened [another new CL](https://chromium-review.googlesource.com/c/v8/v8/+/4489305). This one focuses on Windows cross-compilation in general for both Clang and MSVC. After it lands, I plan to open the last CL addressing this issue, which will focus on problems with ProbeMemory cross-compilation with MSVC. With those 3 CLs, this issue will be fixed.\n\nWith all that in mind, please review the second CL when you have some free cycles (I\u0027ve already added you to the reviewers). Thanks in advance.",
      "parentUuid": "e382746b_6c64b25d",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "307f5e17_fec16217",
        "filename": "src/d8/d8-test.cc",
        "patchSetId": 1
      },
      "lineNbr": 323,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-29T15:00:50Z",
      "side": 1,
      "message": "Any reason to not add the `static` unconditionally?",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "099d8b36_f57f00c5",
        "filename": "src/d8/d8-test.cc",
        "patchSetId": 1
      },
      "lineNbr": 323,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-03-30T23:21:58Z",
      "side": 1,
      "message": "When I tried that, I got the error when cross-compiling Windows x64 to arm64 with clang-cl:\n\n```../../src/d8/d8-test.cc(324,44): error: explicit specialization cannot have a storage class [-Werror]\n  static const FastApiTypedArray\u003cuint8_t\u003e* AnyCTypeToTypedArray\u003cuint8_t\u003e(\n  ~~~~~~~                                  ^```",
      "parentUuid": "307f5e17_fec16217",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1d60d89c_9982995a",
        "filename": "src/d8/d8-test.cc",
        "patchSetId": 1
      },
      "lineNbr": 323,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-31T11:52:58Z",
      "side": 1,
      "message": "I uploaded a CL to simplify this whole thing. Hopefully MSVC likes this as well: https://crrev.com/c/4388581",
      "parentUuid": "099d8b36_f57f00c5",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "fa36da69_cec40b41",
        "filename": "src/d8/d8-test.cc",
        "patchSetId": 1
      },
      "lineNbr": 323,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-04-05T13:06:17Z",
      "side": 1,
      "message": "Thanks, I used this (from the latest main) and confirmed it works in cross-compilation (with other changes required applied).",
      "parentUuid": "1d60d89c_9982995a",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "083cd03c_9c0fe69b",
        "filename": "src/execution/arm64/simulator-arm64.cc",
        "patchSetId": 1
      },
      "lineNbr": 2560,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-29T15:00:50Z",
      "side": 1,
      "message": "Could you use a `std::atomic_thread_fence` instead, on all OSes?",
      "range": {
        "startLine": 2556,
        "startChar": 0,
        "endLine": 2560,
        "endChar": 6
      },
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "94b49a63_122a2b4a",
        "filename": "src/execution/arm64/simulator-arm64.cc",
        "patchSetId": 1
      },
      "lineNbr": 2560,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-03-30T23:21:58Z",
      "side": 1,
      "message": "Thanks for the suggestion, I\u0027ll change these with `std::atomic_thread_fence(std::memory_order_seq_cst);`. The construction I used was already used in this file (that\u0027s why I copied it), so I\u0027ll update those as well.",
      "parentUuid": "083cd03c_9c0fe69b",
      "range": {
        "startLine": 2556,
        "startChar": 0,
        "endLine": 2560,
        "endChar": 6
      },
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "371ae563_1e7a0084",
        "filename": "src/trap-handler/trap-handler-simulator.h",
        "patchSetId": 1
      },
      "lineNbr": 32,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-29T15:00:50Z",
      "side": 1,
      "message": "Is there a definition for this function anywhere?",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d86f596b_43a1f363",
        "filename": "src/trap-handler/trap-handler-simulator.h",
        "patchSetId": 1
      },
      "lineNbr": 32,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-03-30T23:21:58Z",
      "side": 1,
      "message": "No. This is the dirtiest part of the CL by far. This was added mainly for making sure `asm` is not used when cross-compiling with MSVC as that\u0027s forbidden and it was making problems in NodeJS. Additionally, cross-compiling V8 is already broken on Windows with both clang-cl and MSVC (from my tests), so even this doesn\u0027t additionally break anything, but I\u0027m aware of the problem.",
      "parentUuid": "371ae563_1e7a0084",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3ec08391_97f0a290",
        "filename": "src/trap-handler/trap-handler-simulator.h",
        "patchSetId": 1
      },
      "lineNbr": 32,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-31T11:30:47Z",
      "side": 1,
      "message": "I think it would be nicer to go back to this approach (which never landed): https://crrev.com/c/4188385/2/src/trap-handler/trap-handler-simulator.h",
      "parentUuid": "d86f596b_43a1f363",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0d38ebba_9b109818",
        "filename": "test/cctest/test-assembler-arm64.cc",
        "patchSetId": 1
      },
      "lineNbr": 14775,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-29T15:00:50Z",
      "side": 1,
      "message": "Can we express this via `std::aligned_storage`?",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5db6d63e_8d8b8c8b",
        "filename": "test/cctest/test-assembler-arm64.cc",
        "patchSetId": 1
      },
      "lineNbr": 14775,
      "author": {
        "id": 1575637
      },
      "writtenOn": "2023-03-30T23:21:58Z",
      "side": 1,
      "message": "Thanks for the suggestion. As I already mentioned before, I was trying not to change any existing code, so I just added what was needed for cross-compilation with MSVC. I can make that change.",
      "parentUuid": "0d38ebba_9b109818",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f7a86d6b_3eea47f1",
        "filename": "test/cctest/test-assembler-arm64.cc",
        "patchSetId": 1
      },
      "lineNbr": 14775,
      "author": {
        "id": 1556597
      },
      "writtenOn": "2023-03-31T08:36:02Z",
      "side": 1,
      "message": "By looking at this more closely, it seems that std::aligned_storage is deprecated in C++23 [1], and it\u0027s recommended to use alignas instead [2], available from C++11.\n\n[1] https://en.cppreference.com/w/cpp/types/aligned_storage\n[2] https://en.cppreference.com/w/cpp/language/alignas",
      "parentUuid": "5db6d63e_8d8b8c8b",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0106df4e_65515abe",
        "filename": "test/cctest/test-assembler-arm64.cc",
        "patchSetId": 1
      },
      "lineNbr": 14775,
      "author": {
        "id": 1177599
      },
      "writtenOn": "2023-03-31T11:30:47Z",
      "side": 1,
      "message": "Ack, `alignas` would work as well. Just anything that requires less special-casing per compiler / target.",
      "parentUuid": "f7a86d6b_3eea47f1",
      "revId": "92d4e2f5d89cc2c4ed5dea2a0f0c9ca19c87e8eb",
      "serverId": "3ce6091f-6c88-37e8-8c75-72f92ae8dfba"
    }
  ]
}